æœ¬æ–‡ä¸ºçº¯æŠ€æœ¯åˆ†äº«ï¼Œé€‚åˆå¯¹xposedæœ‰å…´è¶£çš„è¯»è€…ï¼Œ

å¦‚æœå¯¹xposedä¸æ„Ÿå…´è¶£ï¼Œè¯·ç‚¹å‡»å·¦ä¸Šè§’è¿”å›æŒ‰é’®~


### å‰è¨€

åœ¨ä¸€ä¸ªå¤œé»‘é£é«˜çš„æ™šä¸Šï¼Œæˆ‘çš„åŸºå‹çªç„¶ç»™æˆ‘å‘äº†ä¸€ä¸ªå«â€œğŸ…ç¤¾åŒºâ€çš„appï¼Œè¿™æ˜¯ä»€ä¹ˆç©æ„ï¼Ÿæ‰¾äº†ä¸€å¼ å¯ä»¥ä¸Šå¢™çš„å›¾


![image.png](https://upload-images.jianshu.io/upload_images/11562793-14cd981a8e688ff0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/200)



æˆ‘å‡‘ï¼Œæ˜¯ä¸ªç¾å¥³ç›´æ’­è½¯ä»¶ï¼Œè¿«ä¸åŠå¾…çš„æˆ‘ï¼Œä¸€é˜µç‚¹ç‚¹ç‚¹ï¼Œå‘ç°æœ€äº®ç‚¹çš„åŠŸèƒ½æ˜¯ç¬¬äºŒä¸ªtabé¡µï¼Œæ˜¯ç±»ä¼¼æŠ–éŸ³çš„çŸ­è§†é¢‘ï¼Œæ‰¾äº†ä¸€å¼ æ­£ç»çš„å›¾ï¼ŒæŠ–éŸ³éƒ½æ²¡è¿™ä¹ˆæ­£ç»å§ã€‚ã€‚ã€‚

![](https://upload-images.jianshu.io/upload_images/11562793-78389e47fa67e29a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/200)




æˆ‘å»ï¼Œåšçš„æ•ˆæœè·ŸæŠ–éŸ³ä¸€æ¯›ä¸€æ ·ï¼Œä¸Šä¸‹æ»‘åŠ¨åˆ‡æ¢è§†é¢‘ï¼ŒèŠè¿™ä¸ªï¼Œé‚£æˆ‘å¯ä¸å›°äº†ï¼Œåœ¨æ»‘åŠ¨äº†å·®ä¸å¤š20ä¸ªè§†é¢‘ä¹‹åï¼Œå‡ºç°äº†è¿™ä¸ª
![image.png](https://upload-images.jianshu.io/upload_images/11562793-f15d2f69cf849da0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/200)

å§æ§½ï¼Œè¿™èƒ½å¿ï¼Œä½œä¸ºä¸€ä¸ªAndroidå¼€å‘æ”»åŸç‹®ï¼Œå……å€¼æ˜¯ä¸å¯èƒ½å……å€¼çš„ã€‚å¤ªæ™šäº†ï¼Œæ‰“ç®—æ˜å¤©å†ç ´è§£å®ƒçš„æ”¶è´¹åŠŸèƒ½ã€‚


äºæ˜¯ï¼Œç¬¬äºŒå¤©å¾ˆæ—©å°±èµ·åºŠæ‰“å¼€ç”µè„‘ï¼Œè¿™ç¯‡æ–‡ç« å°±å¼€å§‹äº†...


### åç¼–è¯‘
å°†apkå‘é€åˆ°ç”µè„‘ï¼Œç„¶åæ‰“å¼€jadx-gui[ä¼ é€é—¨](https://github.com/skylot/jadx)ï¼Œç›´æ¥é€‰æ‹©è¿™ä¸ªapkï¼Œæ‰“å¼€


å‘ç°æºç æ˜¯è¿™ä¸ªæ ·å­çš„
![image.png](https://upload-images.jianshu.io/upload_images/11562793-3c5c8fa409776b6a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


ç†Ÿæ‚‰é€†å‘çš„æœ‹å‹ä»¬è‚¯å®šçŒœåˆ°äº†ï¼Œè¿™ä¸ªapkä½¿ç”¨äº†è…¾è®¯åŠ å›ºï¼Œæ‰€ä»¥åç¼–è¯‘å‡ºæ¥åªæœ‰è…¾è®¯åŠ å›ºçš„å‡ ä¸ªç±»ï¼Œçœ‹ä¸åˆ°ç›®æ ‡æºç ã€‚  

é‚£æ€ä¹ˆåŠï¼Ÿ

æ—¢ç„¶åŠ å›ºäº†ï¼Œç¬¬ä¸€æ­¥å°±æ˜¯è¦ç»™å®ƒè„±å£³

### è„±å£³(éœ€è¦xposedæ”¯æŒ)
#### FDex2
>é€šè¿‡Hook ClassLoaderçš„loadClassæ–¹æ³•ï¼Œåå°„è°ƒç”¨getDexæ–¹æ³•å–å¾—Dex(com.android.dex.Dexç±»å¯¹è±¡)ï¼Œåœ¨å°†é‡Œé¢çš„dexå†™å‡ºã€‚

ä¸‹è½½åœ°å€:
>é“¾æ¥:https://pan.baidu.com/s/1f5dmytN4gt1V4Z5gJ46Ubw  å¯†ç :asbw

ä¸‹è½½å®‰è£…ï¼Œåœ¨xposedinstallerä¸­å‹¾é€‰æ¨¡å—å¹¶é‡å¯ï¼Œç„¶åæ‰“å¼€FDex2é€‰æ‹©ç•ªèŒ„ç¤¾åŒºï¼Œç„¶åé‡å¯ç•ªèŒ„ç¤¾åŒºï¼Œå³å¯åœ¨å¯¹åº”ç›®å½•æ‰¾åˆ°dexæ–‡ä»¶çš„è¸ªå½±
è¿™ä¸ªè¿‡ç¨‹ä¸æ˜¯æœ¬æ–‡é‡ç‚¹ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç«   
[Android APKè„±å£³--è…¾è®¯ä¹å›ºã€360åŠ å›ºä¸€é”®è„±å£³](https://www.jianshu.com/p/138c9de2c987)

### åˆ†æä»£ç 
ä¸Šä¸€æ­¥é€šè¿‡FDex2ï¼ŒæˆåŠŸè„±å£³
![image.png](https://upload-images.jianshu.io/upload_images/11562793-e709f9590c1f0623.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


æ‹¿åˆ°ä¸‰ä¸ªdexï¼Œä¾æ¬¡ç”¨jadx-guiæ‰“å¼€ï¼Œæ ¹æ®åŒ…åï¼Œå¯ä»¥æ‰¾åˆ°å¯¹åº”Activityçš„ä½ç½®
![image.png](https://upload-images.jianshu.io/upload_images/11562793-2bf35307b7df814d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

å¦‚ä½•å¾—åˆ°Activityåç§°ï¼Œè¿™ä¸ªå¯ä»¥ç”¨æ— éšœç¢ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è¿‡æ»¤æ—¥å¿—ï¼Œæ¯”å¦‚ï¼Œæ‰“å¼€ç•Œé¢ï¼Œç„¶åæ—¥å¿—è¿‡æ»¤â€œstart|activityâ€
```
D: pid=30739, uid=10274, component=ComponentInfo{com.one.tomato/com.one.tomato.ui.StartUpActivity}
I: AppChangeImpl:pid: 30739 uid: 10274 pkg: com.one.tomato class: com.one.tomato.ui.StartUpActivity
D: activityResumed:pid=30739, uid=10274, component=ComponentInfo{com.one.tomato/com.one.tomato.ui.StartUpActivity}
D: checkIsMonitorVideoScence input :com.one.tomato,com.one.tomato.ui.StartUpActivity
D: handleActivityChange,  curPackage:com.one.tomato, curClass:com.one.tomato.ui.StartUpActivity
D: checkIsMonitorAPKScence input :com.one.tomato,com.one.tomato.ui.StartUpActivity
D: handleActivityChange, it is not a care app or scence
D: handleActivityChange,  curr mAppType:-1, lastType:-1
```
com.one.tomato.ui.StartUpActivity å°±æ˜¯ä¸»é¡µäº†

ä¸»é¡µä¸€å…±æœ‰5ä¸ªtabï¼Œæ¯ä¸ªtabåº”è¯¥å¯¹åº”ä¸€ä¸ªfragmentï¼Œæˆ‘ä»¬è¦å…ˆæ‰¾åˆ°ç¬¬äºŒä¸ªtabå¯¹åº”çš„fragment


![image.png](https://upload-images.jianshu.io/upload_images/11562793-f0f7b070e952a8b6.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


çœ‹åˆ°ç‚¹å‡»äº‹ä»¶ï¼Œé€šè¿‡å‘½åæ–¹å¼å¯ä»¥çŒœåˆ°è¿™ä¸ªæ˜¯åº•éƒ¨tabçš„ç‚¹å‡»äº‹ä»¶ï¼Œç‚¹ä¸€ä¸‹åº”è¯¥ä¼šåˆ‡æ¢æ˜¾ç¤ºfragment

![image.png](https://upload-images.jianshu.io/upload_images/11562793-b583b1b4007a8ac2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

æœç„¶ä¸å‡ºæˆ‘æ‰€æ–™ï¼Œç¬¬äºŒä¸ªtabæ˜¯PapaTabFragmentï¼Œæœç´¢ä¸€ä¸‹
![image.png](https://upload-images.jianshu.io/upload_images/11562793-25944f1dfa7f3b19.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

æ‰“å¼€çœ‹çœ‹
![](https://upload-images.jianshu.io/upload_images/11562793-e84d9483acbb286f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

è™½ç„¶ä»£ç è¢«æ··æ·†äº†ï¼Œä½†æ˜¯å¯ä»¥çŒœåˆ°è¿™é‡Œæ˜¯åˆå§‹åŒ–çš„æ–¹æ³•ï¼Œæœ‰å¤´åƒå’Œæ”¶è—å›¾æ ‡çš„ç‚¹å‡»äº‹ä»¶ï¼Œå½“ç„¶ï¼Œè¿™ä¸ªä¸æ˜¯é‡ç‚¹ï¼Œå“ˆå“ˆï¼Œæˆ‘ä»¬è¿˜æ˜¯è¦å…ˆåˆ†æä¸€ä¸‹ä»€ä¹ˆæ—¶å€™è§¦å‘è¿™ä¸ªå¼¹çª—ï¼Œå¼¹çª—çš„æ¡ä»¶æ˜¯æ’­æ”¾æ¬¡æ•°åˆ°è¾¾åˆ°ä¸€ä¸ªå€¼ï¼Œæ ¹æ®è¿™ä¸ªæ¡ä»¶ï¼Œå¿«é€Ÿæµè§ˆä¸€ä¸‹PapaTabFragmentè¿™ä¸ªç±»ï¼Œä»£ç ä¸å¤šï¼Œåªæœ‰1åƒè¡Œå¤šä¸€ç‚¹

![image.png](https://upload-images.jianshu.io/upload_images/11562793-c578601b4ad72489.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
å‘ç°ç–‘ç‚¹ï¼ŒLookTimesæ˜¯è§‚çœ‹æ—¶é—´ï¼ŒVideoPlayCountUtilsæ˜¯æ’­æ”¾æ¬¡æ•°ã€‚

VideoPlayCountUtils æ˜¯ä¸€ä¸ªå•ä¾‹ï¼Œæ‰€ä»¥çœ‹bå’Œcæ–¹æ³•
![image.png](https://upload-images.jianshu.io/upload_images/11562793-5a99a79e82fe6196.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

â€œvideo_play_countâ€ è¿™ä¹ˆæ˜æ˜¾çš„å­—çœ¼ï¼Œæ’­æ”¾æ¬¡æ•°ï¼Œè¿™ä¸ªæ¬¡æ•°æ˜¯ä»PreferencesUtilä¸­è·å–çš„ï¼Œä¹Ÿå°±æ˜¯å­˜åœ¨spä¸­ï¼Œ

![image.png](https://upload-images.jianshu.io/upload_images/11562793-768ea80a879a27dd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


PreferencesUtil ä¸­çš„eæ–¹æ³•ï¼Œå¦‚æœç™»å½•ä¿¡æ¯ä¸ä¸ºç©ºï¼Œå°±è¿”å›ä¿¡æ¯ä¸­çš„idï¼Œç©ºå°±è¿”å›0ï¼Œæ‰€ä»¥ç¬¬ä¸€æ¬¡æ‰“å¼€æ‰ä¼šæ˜¯0ï¼Œå¯ä»¥è§‚çœ‹ï¼Œä¹‹åè¿™ä¸ªLoginInfoä¸ä¸ºç©ºäº†ï¼Œå¼€å§‹ç»Ÿè®¡è§‚çœ‹æ¬¡æ•°äº†ã€‚

soï¼Œè®©å®ƒæ€»æ˜¯è¿”å›0ï¼Ÿ


### ä¸Šä»£ç 
Xposedæ¨¡å—å¼€å‘åŸºç¡€å°±ä¸è¯´äº†ï¼Œé»˜è®¤ä½ å·²ç»ä¼šäº†ï¼Œä¸ä¼šè‡ªå·±å»æŸ¥ä¸€ä¸‹ï¼ŒXposedåŸºç¡€ä¸æ˜¯æœ¬æ–‡çš„é‡ç‚¹ã€‚
```
//æ’­æ”¾æ•°æ€»è¿”å›0ï¼Œæ— é™åˆ¶è§‚çœ‹
    private static void hookVideoCount(XC_LoadPackage.LoadPackageParam param, ClassLoader loader){
        LogUtil.d(TAG,"hookVideoCount start");

        hook_method("com.one.tomato.utils.PreferencesUtil", loader, "e", new XC_MethodHook() {

            @Override
            protected void beforeHookedMethod(MethodHookParam param) throws Throwable {

                LogUtil.d(TAG,"beforeHookedMethod hookVideoCount");

            }

            @Override
            protected void afterHookedMethod(MethodHookParam param) throws Throwable {
                LogUtil.d(TAG,"afterHookedMethod è§†é¢‘æ¬¡æ•°è¿”å› 0 ");
                param.setResult(0);


            }
        });
    }

protected static void hook_method(String className, ClassLoader classLoader, String methodName,
                             Object... parameterTypesAndCallback) {
        try {
            XposedHelpers.findAndHookMethod(className, classLoader, methodName, parameterTypesAndCallback);
        } catch (Exception e) {
            XposedBridge.log(e);
            xLog(e.getMessage());
        }
    }
```


ç„¶åå…¶å®ä¼šå‘ç°ä¸€ä¸ªé—®é¢˜ï¼Œclass not found,æ‰¾äº†å¾ˆä¹…ï¼Œæœ€åæ‰ååº”è¿‡æ¥ï¼Œå› ä¸ºapkç»è¿‡åŠ å›ºï¼Œå¿…é¡»è¦ç”¨å£³çš„ClassLoaderæ¥åŠ è½½ç±»ï¼Œå› ä¸ºçœŸæ­£çš„ä»£ç æ˜¯è…¾è®¯åŠ å›ºç¨‹åºå¯åŠ¨åå®ƒå»åŠ è½½çœŸæ­£çš„dexæ–‡ä»¶çš„ã€‚



![image.png](https://upload-images.jianshu.io/upload_images/11562793-76c5ea01eb21a8dd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)

è¿™é‡Œæˆ‘ä»¬å¯ä»¥hook TxAppEntry çš„ attachBaseContext æ–¹æ³•

```
public static void hookClassLoader(final XC_LoadPackage.LoadPackageParam loadPackageParam){
        if (classLoader == null){

            try {
                //è…¾è®¯åŠ å›ºï¼Œéœ€è¦è·å–å¯¹åº”classloader
                XposedHelpers.findAndHookMethod("com.tencent.StubShell.TxAppEntry", loadPackageParam.classLoader,
                        "attachBaseContext", Context.class, new XC_MethodHook() {
                            @Override
                            protected void afterHookedMethod(MethodHookParam param) throws Throwable {
                                super.afterHookedMethod(param);
                                //è·å–åˆ°Contextå¯¹è±¡ï¼Œé€šè¿‡è¿™ä¸ªå¯¹è±¡æ¥è·å–classloader
                                Context context = (Context) param.args[0];
                                //è·å–classloaderï¼Œä¹‹åhookåŠ å›ºåçš„å°±ä½¿ç”¨è¿™ä¸ªclassloader
                                TomatoModule.classLoader = context.getClassLoader();
                                LogUtil.d("æˆåŠŸhook classloader");

                                hookAD(loadPackageParam, classLoader);

                                openLog(loadPackageParam, classLoader);

                                hookVideoCount(loadPackageParam, classLoader);


                            }

                        });
            }catch (Exception e){
                LogUtil.e(e.getMessage());
            }
        }

    }

```

ç„¶åå®‰è£…è¯•äº†ä¸€ä¸‹ï¼Œå§æ§½ï¼ŒçœŸçš„æ— é™åˆ¶è§‚çœ‹äº†ï¼Œæˆ‘æ˜¯V8?

ç¡®å®æˆåŠŸäº†ï¼Œæ•ˆæœå›¾å°±ä¸å‘äº†ï¼Œå¤§å®¶å¯ä»¥åŠ¨æ‰‹è¯•è¯•ã€‚

---

å¦å¤–ï¼Œè·³è¿‡é¦–é¡µå¹¿å‘Šå’Œæ‰“å¼€æ—¥å¿—çš„hookç‚¹æˆ‘ä¹Ÿå¾ˆå¿«æ‰¾åˆ°äº†

```
//è‡ªåŠ¨è·³è¿‡å¹¿å‘Š
    private static void hookAD(XC_LoadPackage.LoadPackageParam param, ClassLoader loader) {
        LogUtil.d(TAG,"hook StartUpActivity start");
        hook_method("com.one.tomato.ui.StartUpActivity", loader, "onCreate", Bundle.class, new XC_MethodHook() {

            @Override
            protected void afterHookedMethod(MethodHookParam param) throws Throwable {
                LogUtil.d(TAG,"beforeHookedMethod onCreate");
                Object object = param.thisObject;
                LogUtil.d(object.toString());
                Class<?> aClass = object.getClass();
                Method[] methods = aClass.getDeclaredMethods();
                for (Method method : methods) {

                    LogUtil.d(method.getName());
                    if (method.getName().equals("z")){
                        LogUtil.d("è‡ªåŠ¨è·³è¿‡å¹¿å‘Šé¡µ");
                        method.setAccessible(true);
                        method.invoke(object);

                    }
                }

                Toast.makeText((Context) param.thisObject, "xposedå¹¶è·³è¿‡å¹¿å‘Šï¼ŒåŠŸèƒ½æ­£å¸¸", Toast.LENGTH_SHORT).show();

            }
        });

    }


    //æ‰“å¼€æ—¥å¿—å¼€å…³
    private static void openLog(XC_LoadPackage.LoadPackageParam param, ClassLoader loader){
        LogUtil.d(TAG,"hook LogUtil start");
        hook_method("com.one.tomato.utils.LogUtil", loader, "a", int.class,String.class,Object.class, new XC_MethodHook() {

            @Override
            protected void beforeHookedMethod(MethodHookParam param) throws Throwable {

                Object object = param.thisObject;
                LogUtil.d(object.toString());
                Class<?> aClass = object.getClass();
                Method[] methods = aClass.getDeclaredMethods();
                for (Method method : methods) {
                    LogUtil.d(method.getName());
                    if (method.getName().equals("a")){
                        LogUtil.d("openLog");
                        method.setAccessible(true);
                        method.invoke(object,true);
                        return;

                    }
                }

            }

        });
    }
```

ä¸æ˜¯å¾ˆéš¾æ‰¾ï¼Œè¿™é‡Œå°±ç•™ç»™å¤§å®¶è‡ªå·±å»å®è·µå­¦ä¹ äº†ã€‚

---
æ³¨æ„ï¼šä¸ç®¡ğŸ…ç¤¾åŒºåæœŸæ˜¯å¦åœæ­¢æœåŠ¡ï¼ˆä½ æ‡‚çš„ï¼‰ï¼Œæœ¬æ–‡åªæ˜¯xposedæŠ€æœ¯åˆ†äº«ï¼Œæ‹’ç»é»„èµŒæ¯’ï¼Œæºç å·²å¼€æºã€‚

æºç å­¦ä¹ ï¼š[ç‚¹è¿™é‡Œ](https://github.com/lanshifu/XposedDemo) 

å¦å¤–ï¼Œå¯¹äºä¼¸æ‰‹å…šï¼Œå·²ç»ç¼–è¯‘å¥½çš„xposedæ¨¡å—æ”¾ç¾¤é‡Œäº†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥åˆ°ç¾¤é‡Œä¸‹è½½

ç•ªèŒ„æ¨¡å—äº¤æµç¾¤ï¼š 

![](https://upload-images.jianshu.io/upload_images/11562793-44ac17945f6ef5c7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/100)




å£°æ˜ï¼šæœ¬æ–‡å†…å®¹åªä¾›å‚è€ƒå­¦ä¹ ï¼Œä¸èƒ½ç”¨äºå•†ä¸šç”¨é€”å“¦ï¼Œå¦‚æœ‰é—®é¢˜ï¼Œè¯·ç•™è¨€ã€‚

